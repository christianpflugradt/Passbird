image: eclipse-temurin:21-jdk

stages:
  - ğŸ” check
  - âœ… test
  - ğŸ“˜ report
  - ğŸ“¦ release

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
    stage: ğŸ” check

secret_detection:
  stage: ğŸ” check

variables:
  DOCKER_DRIVER: overlay2
  SAST_JAVA_VERSION: 17

before_script: [ export GRADLE_USER_HOME=`pwd`/.gradle ]

ğŸ›  compile:
  stage: ğŸ” check
  script: ./gradlew compileKotlin compileTestKotlin compileJava compileTestJava

ğŸ›¡ï¸ owasp:
  stage: ğŸ” check
  script: JAVA_OPTS="-Xms1g -Xmx2g" ./gradlew dependencyCheckAnalyze
  artifacts:
    paths: [ build/reports/dependency-check-report.html ]
  allow_failure: true
  except: [ tags ]

âœï¸ ktlint:
  stage: ğŸ” check
  script: ./gradlew ktlintCheck
  artifacts:
    paths: [ build/reports/ktlint/* ]

ğŸ“œ license-check:
  stage: ğŸ” check
  script: ./gradlew validateLicenses

ğŸ—ƒ unit-tests:
  stage: âœ… test
  script: ./gradlew test
  needs: [ ğŸ›  compile]
  artifacts:
    paths:
      - build/reports/tests/test/*
      - build/jacoco/test.exec

ğŸ”— integration-tests:
  stage: âœ… test
  script: ./gradlew integration
  needs: [ ğŸ›  compile]
  artifacts:
    paths:
      - build/reports/tests/integration/*
      - build/jacoco/integration.exec

ğŸ§± architecture-tests:
  stage: âœ… test
  script: ./gradlew architecture
  needs: [ ğŸ›  compile]
  artifacts:
    paths:
      - build/reports/tests/architecture/*

ğŸ† test-coverage-verification:
  stage: ğŸ“˜ report
  script: ./gradlew jacocoTestCoverageVerification
  needs:
    - ğŸ—ƒ unit-tests
    - ğŸ”— integration-tests
    - ğŸ§± architecture-tests

ğŸ“Š test-coverage-report:
  stage: ğŸ“˜ report
  coverage: '/Branch Coverage: \d+\.?\d*/'
  script: ./gradlew jacocoTestReport
  needs:
    - ğŸ—ƒ unit-tests
    - ğŸ”— integration-tests
    - ğŸ§± architecture-tests
  artifacts:
    paths: [ build/reports/jacoco/test/html/* ]

ğŸš€ semver:
  stage: ğŸ“¦ release
  image: node:24
  variables:
      GIT_STRATEGY: clone
  script:
    - npm install semantic-release@24.2.0 @semantic-release/gitlab@13.2.3 conventional-changelog-conventionalcommits@8.0.0
    - npx semantic-release -t \${version}
  when: manual
  only: [ main ]
