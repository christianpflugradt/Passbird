image: eclipse-temurin:17-jdk

stages:
  - ğŸ” check
  - âœ… test
  - ğŸ“˜ report
  - ğŸ’³ license
  - ğŸ“¦ release

variables:
  DOCKER_DRIVER: overlay2

before_script:
  - export GRADLE_USER_HOME=`pwd`/.gradle

âš™ compile:
  stage: ğŸ” check
  script: ./gradlew compileKotlin compileTestKotlin compileJava compileTestJava

ğŸ”‘ owasp:
  stage: ğŸ” check
  script: ./gradlew dependencyCheckAnalyze
  artifacts:
    paths:
      - build/reports/dependency-check-report.html
  except:
    - tags

ğŸ… ktlint:
  stage: ğŸ” check
  script: ./gradlew ktlintCheck
  artifacts:
    paths:
      - build/reports/ktlint/*

ğŸ—ƒ unit-tests:
  stage: âœ… test
  script: ./gradlew unitTests
  artifacts:
    paths:
      - build/reports/tests/unitTests/*
      - build/jacoco/unitTests.exec

ğŸ›  integration-tests:
  stage: âœ… test
  script: ./gradlew integrationTests
  artifacts:
    paths:
      - build/reports/tests/integrationTests/*
      - build/jacoco/integrationTests.exec

ğŸ§± architecture-tests:
  stage: âœ… test
  script: ./gradlew architectureTests
  artifacts:
    paths:
      - build/reports/tests/architectureTests/*
      - build/jacoco/architectureTests.exec

ğŸ† test-coverage-verification:
  stage: ğŸ“˜ report
  script: ./gradlew jacocoTestCoverageVerification
  needs:
    - ğŸ—ƒ unit-tests
    - ğŸ›  integration-tests
    - ğŸ§± architecture-tests

ğŸ“Š test-coverage-report:
  stage: ğŸ“˜ report
  coverage: '/Instruction Coverage: \d+\.\d+/'
  script:
    - ./gradlew jacocoTestReport
  needs:
    - ğŸ—ƒ unit-tests
    - ğŸ›  integration-tests
    - ğŸ§± architecture-tests
  artifacts:
    paths:
      - build/reports/jacoco/test/html/*

ğŸ’³ licenses:
  stage: ğŸ’³ license
  script: ./gradlew downloadLicenses
  artifacts:
    paths:
      - build/reports/license/*
  only:
    - tags

ğŸš€ semver:
  stage: ğŸ“¦ release
  image: node:18
  script:
    - npm install semantic-release @semantic-release/gitlab conventional-changelog-conventionalcommits
    - npx semantic-release -t \${version}
  when: manual
  only:
    - main
