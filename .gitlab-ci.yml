image: eclipse-temurin:21-jdk

stages:
  - ðŸ”Ž check
  - âœ… test
  - ðŸ“˜ report
  - ðŸ“¦ release

include:
  - template: Security/SAST.gitlab-ci.yml
  - template: Security/Secret-Detection.gitlab-ci.yml

sast:
  stage: ðŸ”Ž check

semgrep-sast:
  stage: ðŸ”Ž check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: on_success

secret_detection:
  stage: ðŸ”Ž check
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule"'
      when: never
    - when: on_success

variables:
  DEPENDENCY_CHECK_DATA_LOCATION: /cache/owasp
  GRADLE_USER_HOME: /cache
  GRADLE_OPTS: "-Dorg.gradle.daemon=false -Dorg.gradle.logging.level=warn"
  SAST_JAVA_VERSION: 17

ðŸ§¹ owasp db purge:
  stage: ðŸ”Ž check
  script: ./gradlew dependencyCheckPurge && rm -rf "$DEPENDENCY_CHECK_DATA_LOCATION"
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $OWASP_PURGE == "true"'
      when: on_success

ðŸ”„ owasp db update:
  stage: ðŸ”Ž check
  script: ./gradlew dependencyCheckUpdate
  rules:
    - if: '$CI_PIPELINE_SOURCE == "schedule" && $OWASP_UPDATE == "true"'
      when: on_success

.check_base: &check_base
  stage: ðŸ”Ž check
  except: [ schedules ]

ðŸ›  compile:
  <<: *check_base
  script: ./gradlew compileKotlin compileTestKotlin compileJava compileTestJava

ðŸ›¡ï¸ owasp:
  <<: *check_base
  script: JAVA_OPTS="-Xms1g -Xmx2g" ./gradlew dependencyCheckAnalyze
  artifacts:
    paths: [ build/reports/dependency-check-report.html ]
  allow_failure: true
  except:
    - tags
    - schedules

âœï¸ ktlint:
  <<: *check_base
  script: ./gradlew ktlintCheck
  artifacts:
    paths: [ build/reports/ktlint/* ]

ðŸ“œ license check:
  <<: *check_base
  script: ./gradlew checkLicense --no-build-cache
  artifacts:
    paths:
      - build/reports/dependency-license/dependencies-without-allowed-license.json
    when: always

.test_base: &test_base
  stage: âœ… test
  needs: [ ðŸ›  compile]
  except: [ schedules ]

ðŸ—ƒ unit tests:
  <<: *test_base
  script: ./gradlew test
  artifacts:
    paths:
      - build/reports/tests/test/*
      - build/jacoco/test.exec

ðŸ”— integration tests:
  <<: *test_base
  script: ./gradlew integration
  artifacts:
    paths:
      - build/reports/tests/integration/*
      - build/jacoco/integration.exec

ðŸ§± architecture tests:
  <<: *test_base
  script: ./gradlew architecture
  artifacts:
    paths:
      - build/reports/tests/architecture/*

# New anchor for report stage jobs
.report_base: &report_base
  stage: ðŸ“˜ report
  needs:
    - ðŸ—ƒ unit tests
    - ðŸ”— integration tests
    - ðŸ§± architecture tests
  except: [ schedules ]

ðŸ† test coverage verification:
  <<: *report_base
  script: ./gradlew jacocoTestCoverageVerification

ðŸ“Š test coverage report:
  <<: *report_base
  coverage: '/Branch Coverage:\s+(\d+(?:\.\d+)?)%/'
  script: ./gradlew -Dorg.gradle.caching=false -Dorg.gradle.logging.level=info jacocoTestReport
  artifacts:
    paths: [ build/reports/jacoco/test/html/* ]

ðŸš€ semver:
  stage: ðŸ“¦ release
  image: node:25
  variables:
      GIT_STRATEGY: clone
  script: |
    npm install \
      semantic-release@24.2.5 \
      @semantic-release/gitlab@13.2.5 \
      conventional-changelog-conventionalcommits@9.0.0 \
    && npx semantic-release
  when: manual
  only: [ main ]
  except: [ schedules ]
