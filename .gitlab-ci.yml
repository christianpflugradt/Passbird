image: eclipse-temurin:20-jdk

stages:
  - 🔎 check
  - ✅ test
  - 📘 report
  - 📦 release

sast:
    stage: 🔎 check
include:
    - template: Security/SAST.gitlab-ci.yml

variables:
  DOCKER_DRIVER: overlay2
  SAST_JAVA_VERSION: 17

before_script: [ export GRADLE_USER_HOME=`pwd`/.gradle ]

⚙ compile:
  stage: 🔎 check
  script: ./gradlew compileKotlin compileTestKotlin compileJava compileTestJava

🔑 owasp:
  stage: 🔎 check
  script:
    - export JAVA_OPTS="-Xms1g -Xmx2g"
    - ./gradlew dependencyCheckAnalyze
  artifacts:
    paths: [ build/reports/dependency-check-report.html ]
  except: [ tags ]

🏅 ktlint:
  stage: 🔎 check
  script: ./gradlew ktlintCheck
  artifacts:
    paths: [ build/reports/ktlint/* ]

🗃 unit-tests:
  stage: ✅ test
  script: ./gradlew unitTests
  needs: [ ⚙ compile]
  artifacts:
    paths:
      - build/reports/tests/unitTests/*
      - build/jacoco/unitTests.exec

🛠 integration-tests:
  stage: ✅ test
  script: ./gradlew integrationTests
  needs: [ ⚙ compile]
  artifacts:
    paths:
      - build/reports/tests/integrationTests/*
      - build/jacoco/integrationTests.exec

🧱 architecture-tests:
  stage: ✅ test
  script: ./gradlew architectureTests
  needs: [ ⚙ compile]
  artifacts:
    paths:
      - build/reports/tests/architectureTests/*
      - build/jacoco/architectureTests.exec

🏆 test-coverage-verification:
  stage: 📘 report
  script: ./gradlew jacocoTestCoverageVerification
  needs:
    - 🗃 unit-tests
    - 🛠 integration-tests
    - 🧱 architecture-tests

📊 test-coverage-report:
  stage: 📘 report
  coverage: '/Branch Coverage: \d+\.?\d*/'
  script: ./gradlew jacocoTestReport
  needs:
    - 🗃 unit-tests
    - 🛠 integration-tests
    - 🧱 architecture-tests
  artifacts:
    paths: [ build/reports/jacoco/test/html/* ]

🚀 semver:
  stage: 📦 release
  image: node:20
  variables:
      GIT_STRATEGY: clone
  script:
    - npm install semantic-release@22.0.10 @semantic-release/gitlab@12.1.1 conventional-changelog-conventionalcommits@7.0.2
    - npx semantic-release -t \${version}
  when: manual
  only: [ main ]
