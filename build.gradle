plugins {
    id 'java'
    id 'java-library'
    id 'checkstyle'
    id 'pmd'
    id 'jacoco'
    id 'com.github.hierynomus.license' version '0.16.1'
    id 'com.github.spotbugs' version '4.7.5'
    id 'org.owasp.dependencycheck' version '8.4.0'
    id 'com.github.ben-manes.versions' version '0.47.0'
}

sourceCompatibility = 11
targetCompatibility = 11

repositories {
    mavenCentral()
}

pmd {
    consoleOutput = true
    maxFailures = 0
    ruleSets = []
    ruleSetConfig = resources.text.fromFile(rootProject.file("config/pmd/ruleset.xml"))
}

checkstyle {
    maxWarnings = 0
    maxErrors = 0
    configFile = project(':').file('config/checkstyle/checkstyle.xml')
    configProperties = ["checkstyle.suppressions.file" : project(':').file('config/checkstyle/suppressions.xml')]
    toolVersion = '8.32'
}

spotbugs {
    showProgress = true
    effort = "max"
    reportLevel = "low"
    excludeFilter = rootProject.file("config/spotbugs/excludes.xml")
}

spotbugsMain {
    reports {
        xml.enabled = false
        html.enabled = true
    }
}

jacocoTestReport {
    executionData.from = files('build/jacoco/unittests.exec', 'build/jacoco/integrationtests.exec')
    reports {
        xml.enabled = true
        html.enabled = true
    }
}

jacocoTestCoverageVerification {
    violationRules {[
        rule {
            limit {
                counter = 'INSTRUCTION'
                value = 'COVEREDRATIO'
                minimum = 0.95
            }
            failOnViolation true
        },
        rule {
            limit {
                counter = 'BRANCH'
                value = 'COVEREDRATIO'
                minimum = 0.90
            }
            failOnViolation true
        }]
    }
}

dependencyCheck {
    failBuildOnCVSS = 3
    suppressionFile = 'config/owasp/suppressions.xml'
}

task architecturetests(type: Test, group: 'Verification') {
    useJUnitPlatform()
    include '**/*TestAT.class'
}

task unittests(type: Test, group: 'Verification') {
    useJUnitPlatform()
    include '**/*Test.class'
    testLogging {
        events "passed", "failed"
    }
}

task integrationtests(type: Test, group: 'Verification') {
    useJUnitPlatform()
    include '**/*TestIT.class'
    testLogging {
        events "passed", "failed"
    }
}

task checkAll() {
    dependsOn checkstyleMain
    dependsOn pmdMain
    dependsOn spotbugsMain
    dependsOn unittests
    dependsOn integrationtests
    dependsOn architecturetests
    dependsOn jacocoTestCoverageVerification
    dependsOn jacocoTestReport
    dependsOn tasks.findByName('downloadLicenses')
    tasks.findByName('jacocoTestReport').mustRunAfter 'unittests'
    tasks.findByName('jacocoTestReport').mustRunAfter 'integrationtests'
}

dependencies {
    implementation 'com.fasterxml.jackson.core:jackson-databind:2.15.2'
    implementation 'com.fasterxml.jackson.dataformat:jackson-dataformat-yaml:2.15.2'
    implementation 'io.vavr:vavr:0.10.4'
    implementation 'com.google.inject:guice:7.0.0'
    implementation 'com.google.inject.extensions:guice-assistedinject:7.0.0'
    implementation 'com.google.guava:guava:32.1.2-jre'
    compileOnly 'org.projectlombok:lombok:1.18.22'
    annotationProcessor 'org.projectlombok:lombok:1.18.22'

    testCompileOnly 'org.projectlombok:lombok:1.18.28'
    testAnnotationProcessor 'org.projectlombok:lombok:1.18.28'
    testImplementation  'org.junit.jupiter:junit-jupiter-api:5.10.0'
    testRuntimeOnly 'org.junit.jupiter:junit-jupiter-engine:5.10.0'
    testImplementation 'org.mockito:mockito-junit-jupiter:5.5.0'
    testImplementation 'org.mockito:mockito-core:5.5.0'
    testImplementation  'org.assertj:assertj-core:3.24.2'
    testImplementation  'org.awaitility:awaitility:4.2.0'
    testImplementation 'com.tngtech.archunit:archunit:1.1.0'
}

jar {
    duplicatesStrategy = DuplicatesStrategy.EXCLUDE
    manifest {
        attributes "Main-Class": "de.pflugradts.pwman3.application.Main",
       'Implementation-Version': project.version && !project.version.empty ? project.version : 'snapshot'
    }

    from {
        configurations.compileClasspath.collect { it.isDirectory() ? it : zipTree(it) }
    }
}
